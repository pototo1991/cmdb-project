{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}Dashboard de Incidencias{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'gestion/css/graficos.css' %}">
{% endblock %}

{% block extra_nav_buttons %}
    {% include 'gestion/_extra_nav_buttons.html' %}
{% endblock extra_nav_buttons %}

{% block content %}
<div class="page-container" 
     data-url-graficos-data="{% url 'gestion:graficos_data' %}" 
     data-url-codigos-cierre="{% url 'gestion:codigos_cierre_por_aplicativo' %}">

    <div class="page-header">
        <h1 class="page-title">Dashboard de Incidencias</h1>
    </div>

    <div class="filter-box">
        <div class="filter-header" id="toggle-filters-header">
            <h3>Filtros de Búsqueda</h3>
            <button id="toggle-filters-btn" class="btn-secondary" type="button">Mostrar Filtros</button>
        </div>
        <div id="filter-container" style="display: none;">
            <form id="graficos-filters-form">
                <div class="filter-grid">

                    <div class="filter-group">
                        <label for="aplicativo">Aplicativo</label>
                        <select name="aplicativo" id="aplicativo" class="form-control">
                            <option value="">Todos</option>
                            {% for app in aplicaciones %}
                                <option value="{{ app.id }}">{{ app.nombre_aplicacion }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="codigo_cierre">Código de Cierre</label>
                        <select name="codigo_cierre" id="codigo_cierre" class="form-control">
                            <option value="">Todos</option>
                            {# Las opciones se cargarán con JavaScript #}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="severidad">Severidad</label>
                        <select name="severidad" id="severidad" class="form-control">
                            <option value="">Todas</option>
                            {% for sev in severidades %}
                                <option value="{{ sev.id }}">{{ sev.desc_severidad }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="bloque">Bloque</label>
                        <select name="bloque" id="bloque" class="form-control">
                            <option value="">Todos</option>
                            {% for b in bloques %}
                                <option value="{{ b.id }}">{{ b.desc_bloque }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="usuario">Usuario Asignado</label>
                        <select name="usuario" id="usuario" class="form-control">
                            <option value="">Todos</option>
                            {% for u in usuarios %}
                                <option value="{{ u.id }}">{{ u.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="fecha_desde">Fecha Desde</label>
                        <input type="date" name="fecha_desde" id="fecha_desde" class="form-control">
                    </div>

                    <div class="filter-group">
                        <label for="fecha_hasta">Fecha Hasta</label>
                        <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control">
                    </div>

                    <div class="filter-group">
                        <label for="year">Año</label>
                        <select name="year" id="year" class="form-control">
                            <option value="">Todos</option>
                            {% for y in years %}
                                <option value="{{ y.year }}">{{ y.year }}</option>
                            {% endfor %}
                        </select>
                    </div>

                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn filter-btn">Aplicar Filtros</button>
                    <button type="button" id="limpiar-filtros-btn" class="btn filter-btn">Limpiar</button>
                </div>
            </form>
        </div>
    </div>
    <div class="stats-container">
        <div class="stat-card">
            <h4>Total General Incidencias</h4>
            <p id="total-general-valor" class="stat-value">0</p>
        </div>
        <div class="stat-card">
            <h4>Total Incidencias (Filtrado)</h4>
            <p id="total-filtrado-valor" class="stat-value">0</p>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="chart-card">
            <div class="chart-container">
                <canvas id="chartPorAplicativo"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-container">
                <canvas id="chartPorMes"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-container">
                <canvas id="chartPorSeveridad"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-container">
                <canvas id="chartPorCodigoCierre"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- jQuery y Chart.js ya se cargan desde base.html. -->
    <script src="{% static 'gestion/js/graficos.js' %}"></script>
{% endblock extra_scripts %}