{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}
    {% if incidencia %}
        Editar Incidencia
    {% else %}
        Registrar Incidencia
    {% endif %}
{% endblock %}

{% block extra_css %}<link rel="stylesheet" href="{% static 'gestion/css/registrar_incidencia.css' %}">{% endblock %}

{% block extra_nav_buttons %}
    {% include 'gestion/_extra_nav_buttons.html' %}
{% endblock extra_nav_buttons %}

{% block content %}
<div class="main-content page-container-incidencia"
     data-aplicacion-id="{{ incidencia.aplicacion.id|default:'' }}"
     data-codigo-cierre-id="{{ incidencia.codigo_cierre.id|default:'' }}"
     data-codigos-cierre-url="{% url 'gestion:get_codigos_cierre_por_aplicacion' 0 %}"
>
    <div class="page-header">
        <h1 class="page-title">
            {% if incidencia %}
                Editar Incidencia
            {% else %}
                Registrar Nueva Incidencia
            {% endif %}
        </h1>
    </div>

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li class="message {{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    <form method="post" action="{% if incidencia %}{% url 'gestion:editar_incidencia' incidencia.id %}{% else %}{% url 'gestion:registrar_incidencia' %}{% endif %}" class="registration-form-layout" autocomplete="off">
        {% csrf_token %}

        <div class="form-column">
            <div class="form-block">
                <h3 class="form-block-title">Datos Principales</h3>
                <div class="form-group">
                    <label for="incidencia">ID Incidencia</label>
                    <input type="text" id="incidencia" name="incidencia" value="{% if form_data %}{{ form_data.incidencia }}{% else %}{{ incidencia.incidencia|default:'' }}{% endif %}" required {% if incidencia %}readonly{% endif %}>
                </div>
                <div class="form-group">
                    <label for="aplicacion">Aplicación</label>
                    <select id="aplicacion" name="aplicacion" required>
                        <option value="">Seleccione una aplicación...</option>
                        {% for app in aplicaciones|dictsort:"nombre_aplicacion" %}
                            <option value="{{ app.id }}" {% if app.id == incidencia.aplicacion.id %}selected{% endif %}>
                                {{ app.nombre_aplicacion }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="descripcion_incidencia">Descripción</label>
                    <textarea id="descripcion_incidencia" name="descripcion_incidencia" rows="4">{{ incidencia.descripcion_incidencia }}</textarea>
                </div>
            </div>

            <div class="form-block">
                <h3 class="form-block-title">Análisis y Solución</h3>
                <div class="form-group">
                    <label for="causa">Causa</label>
                    <textarea id="causa" name="causa" rows="3">{{ incidencia.causa }}</textarea>
                </div>
                <div class="form-group">
                    <label for="tec_analisis">Análisis Técnico</label>
                    <textarea id="tec_analisis" name="tec_analisis" rows="3">{{ incidencia.tec_analisis }}</textarea>
                </div>
                <div class="form-group">
                    <label for="correccion">Corrección</label>
                    <textarea id="correccion" name="correccion" rows="3">{{ incidencia.correccion }}</textarea>
                </div>
                <div class="form-group">
                    <label for="solucion_final">Solución Final</label>
                    <textarea id="solucion_final" name="solucion_final" rows="3">{{ incidencia.solucion_final }}</textarea>
                </div>
            </div>
        </div>


        <div class="form-column">
            <div class="form-block">
                <h3 class="form-block-title">Clasificación</h3>
                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado" name="estado" required>
                        <option value="" disabled selected>Seleccione un estado...</option>
                        {% for est in estados %}
                            <option value="{{ est.id }}" {% if est.id == incidencia.estado.id %}selected{% endif %}>{{ est.desc_estado }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="impacto">Impacto</label>
                    <select id="impacto" name="impacto" required>
                        <option value="" disabled selected>Seleccione un impacto...</option>
                        {% for imp in impactos %}
                            <option value="{{ imp.id }}" {% if imp.id == incidencia.impacto.id %}selected{% endif %}>{{ imp.desc_impacto }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="severidad">Severidad</label>
                    <select id="severidad" name="severidad">
                        <option value="" disabled selected>Seleccione severidad...</option>
                        {% for sev in severidades %}
                            <option value="{{ sev.id }}" {% if sev.id == incidencia.severidad.id %}selected{% endif %}>{{ sev.desc_severidad }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="bloque">Bloque</label>
                    <select id="bloque" name="bloque" required>
                        <option value="" disabled selected>Seleccione un bloque...</option>
                        {% for blq in bloques %}
                            <option value="{{ blq.id }}" {% if blq.id == incidencia.bloque.id %}selected{% endif %}>{{ blq.desc_bloque }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-block">
                <h3 class="form-block-title">Detalles de Cierre</h3>
                <div class="form-group">
                    <label for="interfaz">Interfaz</label>
                    <select id="interfaz" name="interfaz"><option value="">Seleccione una interfaz...</option>{% for ifaz in interfaces %}<option value="{{ ifaz.id }}" {% if ifaz.id == incidencia.interfaz.id %}selected{% endif %}>{{ ifaz.desc_interfaz }}</option>{% endfor %}</select>
                </div>
                <div class="form-group">
                    <label for="cluster">Cluster</label>
                    <select id="cluster" name="cluster"><option value="">Seleccione un cluster...</option>{% for clu in clusters %}<option value="{{ clu.id }}" {% if clu.id == incidencia.cluster.id %}selected{% endif %}>{{ clu.desc_cluster }}</option>{% endfor %}</select>
                </div>
                <div class="form-group">
                    <label for="codigo_cierre">Código de Cierre</label>
                    <select id="codigo_cierre" name="codigo_cierre">
                        <option value="">Seleccione una aplicación primero...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="observaciones">Observaciones</label>
                    <textarea id="observaciones" name="observaciones" rows="3">{{ incidencia.observaciones }}</textarea>
                </div>
                <div class="form-group">
                    <label for="demandas">Demandas</label>
                    <textarea id="demandas" name="demandas" rows="3">{{ incidencia.demandas }}</textarea>
                </div>
                <div class="form-group">
                    <label for="workaround">Workaround Disponible</label>
                    <select id="workaround" name="workaround" class="form-control">
                        <option value="No" {% if incidencia.workaround == "No" %}selected{% endif %}>No</option>
                        <option value="Sí" {% if incidencia.workaround == "Sí" %}selected{% endif %}>Sí</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-column">
            <div class="form-block">
                <h3 class="form-block-title">Fechas y Asignación</h3>
                <div class="form-group">
                    <label for="fecha_apertura">Fecha de Apertura</label>
                    <input type="datetime-local" id="fecha_apertura" name="fecha_apertura" value="{{ incidencia.fecha_apertura|date:'Y-m-d\TH:i' }}">
                </div>
                <div class="form-group">
                    <label for="fecha_ultima_resolucion">Fecha de Resolución</label>
                    <input type="datetime-local" id="fecha_ultima_resolucion" name="fecha_ultima_resolucion" value="{{ incidencia.fecha_ultima_resolucion|date:'Y-m-d\TH:i' }}">
                </div>
                <div class="form-group">
                    <label for="usuario_asignado">Usuario Resolutor</label>
                    <select id="usuario_asignado" name="usuario_asignado">
                        <option value="">Seleccione un usuario...</option>
                        {% for usuario in usuarios %}
                            <option value="{{ usuario.id }}" {% if usuario.id == incidencia.usuario_asignado.id %}selected{% endif %}>{{ usuario.nombre }} ({{ usuario.usuario }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="grupo_resolutor">Grupo Resolutor</label>
                    <select id="grupo_resolutor" name="grupo_resolutor"><option value="">Seleccione un grupo...</option>{% for grupo in grupos_resolutores %}<option value="{{ grupo.id }}" {% if grupo.id == incidencia.grupo_resolutor.id %}selected{% endif %}>{{ grupo.desc_grupo_resol }}</option>{% endfor %}</select>
                </div>
            </div>
            <div class="form-block">
                <h3 class="form-block-title">Bitácora (*)</h3>
                <div class="form-group">
                    
                    <textarea id="bitacora" name="bitacora" rows="3">{{ incidencia.bitacora }}</textarea>
                </div>
                
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if incidencia %}
                    Actualizar Incidencia
                {% else %}
                    Registrar Incidencia
                {% endif %}
            </button>
            <!-- <a href="#" class="btn btn-secondary">Carga Masiva Inicial</a> -->
            <a href="{% url 'gestion:incidencias' %}" class="btn btn-secondary link-con-spinner">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}


{% block extra_scripts %}
    <script src="{% static 'gestion/js/registrar_incidencia.js' %}"></script>
{% endblock extra_scripts %}