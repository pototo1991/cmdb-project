{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}
    {% if codigo_cierre %}
        Editar Código de Cierre - CMDB
    {% else %}
        Registrar Código de Cierre - CMDB
    {% endif %}
{% endblock %}

{% block extra_css %}<link rel="stylesheet" href="{% static 'gestion/css/registrar_cod_cierre.css' %}">{% endblock %}

{% block extra_nav_buttons %}
    <a href="{% url 'gestion:incidencias' %}" class="navbar-link link-con-spinner">Listado Incidencias</a>
    <a href="{% url 'gestion:codigos_cierre' %}" class="navbar-link link-con-spinner">Mantenedor Códigos de Cierre</a>
    <a href="{% url 'gestion:aplicaciones' %}" class="navbar-link link-con-spinner">Mantenedor Aplicaciones</a>
{% endblock extra_nav_buttons %}

{% block main_class %}main-content-centered{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">
            {% if codigo_cierre %}
                Editar Código de Cierre
            {% else %}
                Registrar Nuevo Código de Cierre
            {% endif %}
        </h1>
    </div>

    <div class="table-container">
        
        <form method="post" action="{% if codigo_cierre %}{% url 'gestion:editar_cod_cierre' codigo_cierre.id %}{% else %}{% url 'gestion:registrar_cod_cierre' %}{% endif %}">
            {% csrf_token %}

            <div class="simple-form-layout">

                <div class="form-group">
                    <label for="aplicacion">(*) Aplicación Involucrada</label>
                    
                    <select id="aplicacion" 
                            name="aplicacion" 
                            {% if not codigo_cierre %}data-url="{% url 'gestion:get_ultimos_codigos_cierre' 0 %}"{% endif %}
                            required>
                        <option value="">-- Seleccione aplicación --</option>
                        
                        {# SE AÑADE EL FILTRO |dictsort:"nombre_aplicacion" PARA ORDENAR #}
                        {% for app in todas_las_aplicaciones|dictsort:"nombre_aplicacion" %}
                            <option value="{{ app.id }}" {% if codigo_cierre.aplicacion.id == app.id %}selected{% endif %}>{{ app.nombre_aplicacion }} ({{ app.cod_aplicacion }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="cod_cierre">(*) Código de Cierre</label>
                    <input type="text" id="cod_cierre" name="cod_cierre" value="{{ codigo_cierre.cod_cierre|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label for="desc_cod_cierre">(*) Descripción Código Cierre</label>
                    <textarea id="desc_cod_cierre" name="desc_cod_cierre" rows="3" required>{{ codigo_cierre.desc_cod_cierre|default:'' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="causa_cierre">(*) Causa Cierre</label>
                    <textarea id="causa_cierre" name="causa_cierre" rows="3" required>{{ codigo_cierre.causa_cierre|default:'' }}</textarea>
                </div>

            </div>

            <div class="form-actions" style="justify-content: center; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">Guardar</button>
                {% if not codigo_cierre %}
                <a href="{% url 'gestion:carga_masiva_cod_cierre' %}" class="btn btn-secondary link-con-spinner">Carga Masiva</a>
                {% endif %}
                <a href="{% url 'gestion:codigos_cierre' %}" class="btn btn-secondary link-con-spinner">Cancelar</a>
            </div>

        </form>
        
        {# --- INICIO DE LA NUEVA SECCIÓN PARA MOSTRAR ÚLTIMOS CÓDIGOS --- #}
        {# Este bloque solo se renderiza si estamos creando un código nuevo #}
        {% if not codigo_cierre %}
            <div id="ultimos-codigos-container" style="display: none; margin-top: 30px;">
                <h3>Últimos 5 Códigos de Cierre para esta Aplicación</h3>
                <ul id="lista-ultimos-codigos">
                    </ul>
            </div>
        {% endif %}
        {# --- FIN DE LA NUEVA SECCIÓN --- #}

    </div>

{# --- INICIO DEL SCRIPT JAVASCRIPT --- #}
{# Este script también se añade solo si estamos creando un código nuevo #}
{% if not codigo_cierre %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const aplicacionSelect = document.getElementById('aplicacion');
    const container = document.getElementById('ultimos-codigos-container');
    const lista = document.getElementById('lista-ultimos-codigos');
    
    const urlTemplate = aplicacionSelect.dataset.url;

    aplicacionSelect.addEventListener('change', function() {
        const aplicacionId = this.value;

        if (!aplicacionId || !urlTemplate) {
            container.style.display = 'none';
            return;
        }

        const url = urlTemplate.replace('0', aplicacionId);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('La respuesta de la red no fue exitosa.');
                }
                return response.json();
            })
            .then(data => {
                // Se limpia la lista antes de añadir nuevos resultados.
                lista.innerHTML = ''; 

                if (data.codigos && data.codigos.length > 0) {
                    data.codigos.forEach(codigo => {
                        const li = document.createElement('li');

                        const codigoSpan = document.createElement('span');
                        codigoSpan.className = 'codigo-item-code';
                        codigoSpan.textContent = codigo.cod_cierre;

                        const descSpan = document.createElement('span');
                        descSpan.className = 'codigo-item-desc';
                        descSpan.textContent = codigo.desc_cod_cierre;

                        li.appendChild(codigoSpan);
                        li.appendChild(descSpan);

                        lista.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    // **AJUSTE 1: Se añade la clase para el estilo del mensaje.**
                    li.className = 'mensaje-info'; 
                    li.textContent = 'No se encontraron códigos de cierre para esta aplicación.';
                    lista.appendChild(li);
                }

                // **AJUSTE 2: Se mueve esta línea aquí para no repetirla.**
                // Así, el contenedor se muestra tanto si hay resultados como si no.
                container.style.display = 'block';
            })
            .catch(error => {
                console.error('Error al obtener los códigos de cierre:', error);
                const li = document.createElement('li');
                li.className = 'mensaje-info'; // Usamos la misma clase para errores
                li.textContent = 'Ocurrió un error al cargar los datos.';
                lista.appendChild(li);
                container.style.display = 'block';
            });
    });
});
</script>
{% endif %}
{# --- FIN DEL SCRIPT JAVASCRIPT --- #}

{% endblock content %}